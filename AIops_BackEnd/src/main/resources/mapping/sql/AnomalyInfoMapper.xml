<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.aiops_web.dao.sql.AnomalyInfoMapper">

    <select id="getAnomalyInfos" resultType="AnomalyInfo" parameterType="java.util.Map">
        select *
        from anomaly_info
        <where>
            <if test="info.anoId != null and info.anoId!=''">
                ano_id=#{info.anoId} and
            </if>
            <if test="info.objId != null and info.objId!=''">
                obj_id=#{info.objId} and
            </if>
            <if test="info.statusId != null and info.statusId != ''">
                status_id=#{info.statusId} and
            </if>
            <!--  时间部分需要根据粒度来更改一下查询条件 -->
            <if test="info.detectTstamp != null">
                DATE_FORMAT(detect_tstamp, '%Y-%m-%d') = DATE_FORMAT(#{info.detectTstamp}, '%Y-%m-%d') and
            </if>
            <if test="info.predictTstamp != null">
                DATE_FORMAT(predict_tstamp, '%Y-%m-%d') = DATE_FORMAT(#{info.predictTstamp}, '%Y-%m-%d') and
            </if>
            <if test="info.updateTstamp != null">
                DATE_FORMAT(update_tstamp, '%Y-%m-%d') = DATE_FORMAT(#{info.updateTstamp}, '%Y-%m-%d') and
            </if>
            <if test="info.sourceDataIds != null and info.sourceDataIds != ''">
                source_data_ids=#{info.sourceDataIds} and
            </if>
            <if test="info.userId != null and info.userId != ''">
                user_id=#{info.userId} and
            </if>
            <if test="info.wfId != null and info.wfId != ''">
                wf_id=#{info.wfId} and
            </if>
            <if test="info.deleted != null and info.deleted != ''">
                deleted=#{info.deleted} and
            </if>
            1=1
        </where>
        limit #{start}, #{size};
    </select>

    <select id="getById" resultType="AnomalyInfo" >
        select *
        from anomaly_info
        where ano_id=#{anoId};
    </select>

    <delete id="deleteByAnoId" >
        delete
        from anomaly_info
        where ano_id=#{anoId};
    </delete>

    <update id="updateStatusById" >
        update anomaly_info
        set status_id=#{statusId}
        where ano_id=#{anoId};
    </update>


    <update id="updateAnoInfo" >
        update anomaly_info
        <set>
            <if test="objId != null and objId != ''">
                obj_id=#{objId},
            </if>
<!--            <if test="statusId != null and statusId != ''">-->
<!--                status_id=#{statusId},-->
<!--            </if>-->
            <if test="detectTstamp != null">
                detect_tstamp=#{detectTstamp},
            </if>
            <if test="predictTstamp != null">
                predict_tstamp=#{predictTstamp},
            </if>
            <if test="updateTstamp != null">
                update_tstamp=#{updateTstamp},
            </if>
            <if test="sourceDataIds != null and sourceDataIds != ''">
                source_data_ids=#{sourceDataIds},
            </if>
            <if test="userId != null and userId != ''">
                user_id=#{userId},
            </if>
            <if test="wfId != null and wfId != ''">
                wf_id=#{wfId},
            </if>
            <if test="deleted != null and deleted != ''">
                deleted=#{deleted},
            </if>
        </set>
        where ano_id=#{anoId};
    </update>
</mapper>
